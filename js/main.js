!function(){var a={},b=[],d=[],e=new Image,f=new Image,g=new Image,h=[new Image,new Image],i=22,j=0;game=document.getElementById("game"),canvas=document.createElement("canvas"),frame=document.createElement("canvas"),frameWidth=1920,frameHeight=1080,gameWidth=0,gameHeight=0,gameOffsetX=0,gameOffsetY=0,ctx=canvas.getContext("2d"),c=frame.getContext("2d"),aspectRatio=16/9,imageCount=0,heightT=6,widthT=30,width=window.innerWidth,height=window.innerHeight,offset=0,interval=1e3/30,tileSize=Math.floor(frameHeight/heightT),scaledTileSize=tileSize,mouseX=0,mouseY=0,activeRow=1,scrollSpeed=15,now=new Date,before=new Date,money=1e3,isAnvilClicked=0,playerUnits=[],enemyUnits=[],unitButtons=[],particles=[],boss={x:widthT*tileSize,y:tileSize,hp:100,maxhp:100,img:[],frame:0,draw:function(){boss.frame>4&&(boss.frame=0),c.drawImage(this.img[this.frame],this.x-offset,this.y,(heightT-1)*tileSize,(heightT-1)*tileSize),k(this,(heightT-1)*tileSize)}},setInterval(function(){boss.frame++},200);var k=function(a,b){var d=c.createLinearGradient(a.x-offset,a.y,a.x-offset,a.y+20),e=b||tileSize;d.addColorStop(.01,"black"),d.addColorStop(.5,"rgb("+(a.maxhp-a.hp)/a.maxhp*255+","+a.hp/a.maxhp*255+",50)"),d.addColorStop(.99,"black"),c.fillStyle=d,c.fillRect(a.x-offset+e/8,a.y,a.hp/a.maxhp*(.75*e),tileSize/8),c.drawImage(f,a.x-offset+e/8,a.y,.75*e,tileSize/8)},l=function(){var a,b=width/aspectRatio;b>height?(a=height*aspectRatio,b=a/aspectRatio,gameOffsetX=(width-a)/2,gameOffsetY=0):(a=width,gameOffsetX=0,gameOffsetY=(height-b)/2),gameWidth=a,gameHeight=b,scaledTileSize=gameHeight/heightT},m=function(a,b){return!!(a.x>b.x&&a.x<b.x+b.width&&a.y>b.y&a.y<b.y+b.height)},n=function(a,b){return a.width=a.width||tileSize,a.height=a.height||tileSize,b.width=a.width||tileSize,b.height=a.height||tileSize,(a.x+a.width>b.x&&a.x+a.width<b.x+b.width||b.x+b.width>a.x&&b.x+b.width<a.x+a.width)&&(a.y+a.height>b.y&&a.y+a.height<b.y+b.height||b.y+b.height>a.y&&b.y+b.height<a.y+a.height)},o=function(){$.getJSON("https://tismas.github.io/data/heroes.json",function(b){$.each(b,function(b,c){a[b]=c}),s(),p()}).fail(function(){console.log("Failed to load json")})},p=function(){e.onload=s,e.src="assets/bgTile1.png";for(var c=0;c<6;c++)b.push(new Image),b[c].onload=s,b[c].src="assets/stevo"+(c+1)+".png";a.knight.image=b;for(var c=0;c<6;c++)d.push(new Image),d[c].onload=s,d[c].src="assets/sword_position"+(c+1)+".png";a.knight.weapon=d,h[0].onload=s,h[0].src="assets/anvil.png",h[1].onload=s,h[1].src="assets/anvil2.png",f.onload=s,f.src="assets/hp.png",g.onload=s,g.src="assets/moneta1.png";for(var c=0;c<5;c++)boss.img.push(new Image),boss.img[c].onload=s,boss.img[c].src="assets/boss"+(c+1)+".png";q()},q=function(){canvas.width=width,canvas.height=height,frame.width=frameWidth,frame.height=frameHeight,l(),game.appendChild(canvas),unitButtons.push(new u(0*tileSize,0,a.knight,r)),window.onresize=t,B(),C()};o();var r=function(b,c,d){this.x=b,this.y=c,this.maxhp=a.knight.hp,this.hp=this.maxhp,this.dmg=a.knight.dmg,this.speed=a.knight.speed,this.reward=a.knight.reward,this.range=a.knight.range||150,this.attackCooldown=20,this.timeToAttack=0,this.image=a.knight.image,this.weapon=a.knight.weapon,this.moving=!0,this.attacking=!1,this.frame=0,this.frameTime=5,this.frameCnt=0,this.frames=3,this.isEnemy=d||!1};r.prototype={getTarget:function(){if(this.isEnemy)for(var a=0,b=playerUnits.length;a<b;a++){var c=playerUnits[a];if(c&&c.x>=this.x-this.range&&c.y==this.y)return c}else for(var a=0,d=enemyUnits.length;a<d;a++){var e=enemyUnits[a];if(e&&e.x<=this.x+this.range&&e.y==this.y)return e}return null},attack:function(a){0==this.timeToAttack&&this.hp>0&&0==a.attacking&&(this.timeToAttack=this.attackCooldown,this.prepareNextAttack(),this.attacking=!0,setTimeout(this.strike.bind(this,a),200))},strike:function(a){this.hp>0&&(this.swordFrame=2,this.frame=5,a.hp-=this.dmg,a.hp<=0&&enemyUnits.indexOf(a)!=-1&&(money+=a.reward),setTimeout(this.prepareNextAttack.bind(this),125))},prepareNextAttack:function(){this.frame=4,this.swordFrame=1,this.attacking=!1},die:function(){var a=playerUnits.indexOf(this);a!=-1?playerUnits.splice(a,1):(a=enemyUnits.indexOf(this),enemyUnits.splice(a,1)),delete this},draw:function(){if(this.hp<0&&(this.hp=0),this.isEnemy){c.save(),c.translate(this.x,this.y),c.scale(-1,1),c.translate(this.x-tileSize,-this.y);var a=-(this.x-offset);6==this.swordFrame?c.drawImage(this.weapon[this.frame],a+tileSize/5,this.y,tileSize,tileSize):c.drawImage(this.weapon[this.frame],a,this.y,tileSize,tileSize),c.drawImage(this.image[this.frame],a,this.y,tileSize,tileSize),c.restore()}else 6==this.swordFrame?c.drawImage(this.weapon[this.frame],this.x-offset+tileSize/5,this.y,tileSize,tileSize):c.drawImage(this.weapon[this.frame],this.x-offset,this.y,tileSize,tileSize),c.drawImage(this.image[this.frame],this.x-offset,this.y,tileSize,tileSize);k(this),c.fillStyle="#0f0"},update:function(){var a,b=!0,c=this.getTarget();if(this.isEnemy){for(var d=0,e=enemyUnits.length;d<e;d++)if(a=enemyUnits[d],a&&this!==a&&n(a,this)&&this.x>a.x){b=!1,this.moving=!1;break}c&&(b=!1,this.moving=!1,this.frame<=3&&(this.frame=4),this.attack(c)),b&&(this.x-=this.speed,this.moving=!0)}else{for(var d=0,f=playerUnits.length;d<f;d++)if(a=playerUnits[d],a&&this!==a&&n(this,a)&&this.x<a.x){b=!1,this.moving=!1;break}c&&(b=!1,this.moving=!1,this.frame<=3&&(this.frame=4),this.attack(c)),b&&(this.x+=this.speed,this.moving=!0)}this.updateAnimation(),(this.hp<=0||this.x>widthT*tileSize||this.x<0)&&this.die()},updateAnimation:function(){0!=this.timeToAttack&&this.timeToAttack--,this.moving||1!=this.frame&&2!=this.frame?this.moving&&(this.frameCnt++,this.frameCnt>=this.frameTime&&(this.frame++,this.frameCnt=0,this.frame>=this.frames&&(this.frame=1))):this.frame=0}};var s=function(){j++,console.log("Files loaded: "+j+"/"+i)},t=function(){width=window.innerWidth,height=window.innerHeight,canvas.width=width,canvas.height=height,l()};canvas.onmousemove=function(a){mouseX=a.x,mouseY=a.y};canvas.onclick=function(a){a.x<=gameOffsetX+scaledTileSize&&a.y>=gameOffsetY+scaledTileSize&&(activeRow=Math.floor(mouseY/scaledTileSize),activeRow>=heightT&&(activeRow=heighT-1));for(var b=0;b<unitButtons.length;b++)unitButtons[b].collide(a.x,a.y)&&money>=unitButtons[b].cost?unitButtons[b].success():unitButtons[b].collide(a.x,a.y)&&unitButtons[b].fail()};var u=function(a,b,c,d,e,f){this.x=a,this.y=b,this.color=c.color,this.cost=c.price,this.background=e||"#333",this.hover=f||"#555",this.failed=!1,this.succeed=!1,this.statusCounter=0,this.unitDesc=c,this.unitClass=d};u.prototype={fail:function(){this.failed=!0,this.statusCounter=10},success:function(){this.succeed=!0,money-=this.cost,this.statusCounter=5,playerUnits.push(new this.unitClass(0,activeRow*tileSize))},collide:function(a,b){return m({x:a-gameOffsetX,y:b-gameOffsetY},{x:this.x,y:this.y,width:scaledTileSize,height:scaledTileSize})},draw:function(){this.failed?c.fillStyle="#500":this.succeed?c.fillStyle="#050":this.collide(mouseX,mouseY)?c.fillStyle=this.hover:c.fillStyle=this.background,c.fillRect(this.x,this.y,tileSize,tileSize);var a=tileSize-2*tileSize/5;c.drawImage(this.unitDesc.weapon[0],this.x+tileSize/5,this.y+tileSize/10,a,a),c.drawImage(this.unitDesc.image[0],this.x+tileSize/5,this.y+tileSize/10,a,a),c.fillStyle="#fff",c.font="20px Arial";var b="$"+this.cost;c.fillText(b,this.x+tileSize-tileSize/2-c.measureText(b).width/2,this.y+tileSize-15),this.statusCounter>0?this.statusCounter--:(this.failed||this.succeed)&&(this.failed=!1,this.succeed=!1)}};var v=function(){c.fillStyle="#fff",c.fillRect(0,0,frameWidth,1),c.fillRect(0,0,2,tileSize),c.fillRect(0,tileSize,frameWidth,1),c.fillRect(frameWidth-1,0,1,tileSize);var a=Math.round(frameWidth/2/tileSize)-1;c.fillRect(tileSize*a,0,1,tileSize),c.fillRect(tileSize*(a+1),0,1,tileSize)},w=function(){for(var a=0;a<particles.length;a++)particles[a].update()},x=function(){c.fillStyle="#000",c.fillRect(0,0,tileSize*widthT,tileSize);for(var a=0;a<unitButtons.length;a++)unitButtons[a].draw();c.font="20px Arial",c.fillStyle="#fff";var b=Math.round(frameWidth/2/tileSize)-1;c.drawImage(g,tileSize*b+10,tileSize/6,tileSize/5,tileSize/5),c.fillText(money,tileSize*b+tileSize/5+10,tileSize/6+20),anvilX=tileSize*(b+1),c.drawImage(h[isAnvilClicked],anvilX,0,tileSize,tileSize);for(var a=0;a<particles.length;a++)particles[a].draw();v()},y=function(){mouseX<=gameOffsetX+scaledTileSize&&offset>0&&mouseX>=gameOffsetX?offset-=scrollSpeed:mouseX>=width-scaledTileSize-gameOffsetX&&offset<(widthT+heightT)*tileSize-frameWidth&&mouseX<=width-gameOffsetX&&(offset+=scrollSpeed)},z=function(){for(var a,b=0,c=playerUnits.length;b<c;b++)a=playerUnits[b],a&&a.update()},A=function(){for(var a,b=0,c=enemyUnits.length;b<c;b++)a=enemyUnits[b],a&&a.update()},B=function(){now=new Date;var a=now-before;if(a>interval){for(y();a>interval;){var b=Math.floor(500*Math.random());b<heightT-1&&enemyUnits.push(new r(widthT*tileSize,tileSize*(b+1),(!0))),z(),A(),w(),a-=interval}before=now}requestAnimationFrame(C)},C=function(){c.fillStyle="#000",c.fillRect(0,0,frame.width,frame.height);for(var a=Math.floor(offset/tileSize),b=Math.floor(frameWidth/tileSize),d=a;d<=a+b+1;d++)for(var f=0;f<heightT;f++)c.drawImage(e,d*tileSize-offset,f*tileSize,tileSize,tileSize);var g=c.createLinearGradient(-offset-tileSize/8,0,tileSize,0);g.addColorStop(0,"yellow"),g.addColorStop(.5,"transparent");var h=c.createLinearGradient(-offset-tileSize/8,0,tileSize,0);if(h.addColorStop(0,"blue"),h.addColorStop(.5,"transparent"),c.fillStyle=g,c.fillRect(-offset,tileSize*activeRow,tileSize,tileSize),mouseX<=scaledTileSize+gameOffsetX&&mouseY>=scaledTileSize&&mouseX>=gameOffsetX){var i=Math.floor(mouseY/scaledTileSize);i<heightT&&i!=activeRow&&(c.fillStyle=h,c.fillRect(-offset,i*tileSize,tileSize,tileSize))}for(var d=0,j=playerUnits.length;d<j;d++)playerUnits[d].draw();for(var d=0,k=enemyUnits.length;d<k;d++)enemyUnits[d].draw();boss.draw(),x(),ctx.fillStyle="#000",ctx.fillRect(0,0,width,height),ctx.drawImage(frame,gameOffsetX,gameOffsetY,gameWidth,gameHeight),setTimeout(B,interval)}}();