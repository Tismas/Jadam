!function(){var a={},b=[],c=[],d=new Image,e=new Image,f=new Image,g=[new Image,new Image],h=15,i=0,j=document.getElementById("game"),k=document.createElement("canvas"),l=k.getContext("2d"),m=7,n=30,o=window.innerWidth,p=window.innerHeight,q=0,r=1e3/30,s=Math.floor(p/m),t=0,u=0,v=1,w=15,x=new Date,y=new Date,z=100,A=0,B=0,C=[],D=[],E=[],F=[],G=function(a,b,c,d){return c<a+s&&c>a&&d<b+s&&d>=b},H=function(){$.getJSON("https://tismas.github.io/data/heroes.json",function(b){$.each(b,function(b,c){a[b]=c}),L(),I()}).fail(function(){console.log("Failed to load json")})},I=function(){d.onload=L,d.src="assets/background.png";for(var h=0;h<3;h++)b.push(new Image),b[h].onload=L,b[h].src="assets/"+(h+1)+".png";for(var h=3;h<6;h++)b.push(new Image),b[h].onload=L,b[h].src="assets/fightstance"+(h-2)+".png";a.knight.image=b;for(var h=0;h<3;h++)c.push(new Image),c[h].onload=L,c[h].src="assets/sword_position"+(h+1)+".png";a.knight.weapon=c,g[0].onload=L,g[0].src="assets/anvil.png",g[1].onload=L,g[1].src="assets/anvil2.png",e.onload=L,e.src="assets/hp.png",f.onload=L,f.src="assets/moneta1.png",J()},J=function(){k.width=o,k.height=p,j.appendChild(k),E.push(new P(0*s,0,a.knight,K)),window.onresize=M,W(),X()};H();var K=function(b,c){this.x=b,this.y=c,this.hp=a.knight.hp,this.maxhp=a.knight.hp,this.dmg=a.knight.dmg,this.speed=a.knight.speed,this.reward=a.knight.reward,this.attackCooldown=20,this.timeToAttack=0,this.image=a.knight.image,this.weapon=a.knight.weapon,this.moving=!0,this.swordFrame=0,this.frame=0,this.frameTime=5,this.frameCnt=0,this.frames=3,this.attack=function(a){0==this.timeToAttack&&this.hp>0&&(this.timeToAttack=this.attackCooldown,this.prepareNextAttack(),setTimeout(this.strike.bind(this,a),200))},this.prepareNextAttack=function(){this.frame=4,this.swordFrame=1},this.strike=function(a){this.hp>0&&(this.swordFrame=2,this.frame=5,a.hp-=this.dmg,a.hp<=0&&D.indexOf(a)!=-1&&(z+=a.reward),setTimeout(this.prepareNextAttack.bind(this),100))},this.die=function(){var a=C.indexOf(this);a!=-1?C.splice(a,1):(a=D.indexOf(this),D.splice(a,1))},this.draw=function(){var a=l.createLinearGradient(this.x-q,this.y,this.x-q,this.y+20);a.addColorStop(.01,"black"),a.addColorStop(.5,"rgb("+(this.maxhp-this.hp)/this.maxhp*255+","+this.hp/this.maxhp*255+",50)"),a.addColorStop(.99,"black"),l.fillStyle=a,D.indexOf(this)!=-1?(l.save(),l.translate(this.x,this.y),l.scale(-1,1),l.translate(this.x,-this.y),this.moving?(this.frame>=3&&(this.frame=1),l.drawImage(this.weapon[0],-(this.x-q+s/4+(2-this.frame)*(s/10)),this.y+s/4,s,s)):2==this.swordFrame?l.drawImage(this.weapon[this.swordFrame],-(this.x-q+s/3),this.y+s/4,s,s):l.drawImage(this.weapon[this.swordFrame],-(this.x-q+s/4),this.y+s/4,s,s),l.drawImage(this.image[this.frame],-(this.x-q+s/4),this.y+s/4,s,s),l.fillRect(-(this.x-q)-s/5,this.y,this.hp/this.maxhp*(.75*s),s/8),l.drawImage(e,-(this.x-q)-s/5,this.y,.75*s,s/8),l.restore()):(this.moving?(this.frame>=3&&(this.frame=1),l.drawImage(this.weapon[0],this.x-q+s/4-(2-this.frame)*(s/10),this.y+s/4,s,s)):2==this.swordFrame?l.drawImage(this.weapon[this.swordFrame],this.x-q+s/3,this.y+s/4,s,s):l.drawImage(this.weapon[this.swordFrame],this.x-q+s/4,this.y+s/4,s,s),l.drawImage(this.image[this.frame],this.x-q+s/4,this.y+s/4,s,s),l.fillRect(-q+this.x+s/3,this.y,this.hp/this.maxhp*(.75*s),s/8),l.drawImage(e,-q+this.x+s/3,this.y,.75*s,s/8)),l.fillStyle="#0f0"},this.update=function(){0!=this.timeToAttack&&this.timeToAttack--,(this.hp<=0||this.x>=n*s||this.x<0)&&this.die(),this.moving||1!=this.frame&&2!=this.frame?this.moving&&(this.frameCnt++,this.frameCnt>=this.frameTime&&(this.frame++,this.frameCnt=0,this.frame>=this.frames&&(this.frame=1))):this.frame=0}},L=function(){i++,console.log("Files loaded: "+i+"/"+h)},M=function(){var a=window.innerWidth/o,b=window.innerHeight/p;o=window.innerWidth,p=window.innerHeight,k.width=o,k.height=p,s=Math.floor(p/m);for(var c=0;c<E.length;c++)E[c].x=c*s;for(var c=0;c<C.length;c++)C[c].x*=a,C[c].y*=b;for(var c=0;c<D.length;c++)D[c].x*=a,D[c].y*=b;q*=a,q>n*s-o&&(q=n*s-o),W(),X()};k.onmousemove=function(a){t=a.x,u=a.y};var N=function(){A=0};k.onclick=function(a){a.x<=s&&a.y>=s&&(v=Math.floor(u/s),v>=m&&(v=heighT-1));for(var b=0;b<E.length;b++)E[b].collide(a.x,a.y)&&z>=E[b].cost?E[b].success():E[b].collide(a.x,a.y)&&E[b].fail();a.x>=B&&a.x<=B+s&&a.y>=0&&a.y<=s&&(A=1,z++,F.push(new O(B+s/3+(-s/8+Math.random()*(s/4)),s/2)),setTimeout(N,125))};var O=function(a,b){this.x=a,this.y=b,this.draw=function(){l.fillStyle="rgba(255,255,255,"+this.y/b+")",l.fillText("+1",this.x,this.y)},this.update=function(){this.y--,this.y<=0&&(F.splice(F.indexOf(this),1),delete this)}},P=function(a,b,c,d,e,f){this.x=a,this.y=b,this.color=c.color,this.cost=c.price,this.background=e||"#333",this.hover=f||"#555",this.failed=!1,this.succeed=!1,this.statusCounter=0,this.fail=function(){this.failed=!0,this.statusCounter=5},this.success=function(){this.succeed=!0,z-=this.cost,this.statusCounter=5,C.push(new d(0,v*s))},this.collide=function(a,b){return G(this.x,this.y,a,b)},this.draw=function(){this.failed?l.fillStyle="#500":this.succeed?l.fillStyle="#050":G(a,b,t,u)?l.fillStyle=this.hover:l.fillStyle=this.background,l.fillRect(this.x,this.y,s,s);var d=s-2*s/5;l.drawImage(c.weapon[0],this.x+s/5,this.y+s/10,d,d),l.drawImage(c.image[0],this.x+s/5,this.y+s/10,d,d),l.fillStyle="#fff",l.font="20px Arial";var e="$"+this.cost;l.fillText(e,this.x+s-s/2-l.measureText(e).width/2,this.y+s-15),this.statusCounter>0?this.statusCounter--:(this.failed||this.succeed)&&(this.failed=!1,this.succeed=!1)}},Q=function(){l.fillStyle="#fff",l.fillRect(0,0,o,1),l.fillRect(0,0,2,s),l.fillRect(0,s,o,1),l.fillRect(o-1,0,1,s);var a=Math.round(o/2/s)-1;l.fillRect(s*a,0,1,s),l.fillRect(s*(a+1),0,1,s)},R=function(){for(var a=0;a<F.length;a++)F[a].update()},S=function(){l.fillStyle="#000",l.fillRect(0,0,s*n,s);for(var a=0;a<E.length;a++)E[a].draw();l.font="20px Arial",l.fillStyle="#fff";var b=Math.round(o/2/s)-1;l.drawImage(f,s*b+10,s/6,s/5,s/5),l.fillText(z,s*b+s/5+10,s/6+20),B=s*(b+1),l.drawImage(g[A],B,0,s,s);for(var a=0;a<F.length;a++)F[a].draw();Q()},T=function(){t<=s&&q>0?q-=w:t>=o-s&&q<n*s-o&&(q+=w)},U=function(){for(var a=0;a<C.length;a++){for(var b=!0,c=null,d=0;d<C.length;d++)if(a!=d&&G(C[a].x,C[a].y,C[d].x,C[d].y)&&C[a].x<C[d].x){b=!1,C[a].moving=!1;break}for(var d=0;d<D.length;d++)if(G(C[a].x,C[a].y,D[d].x-s,D[d].y)){b=!1,C[a].moving=!1,c=D[d];break}b?(C[a].x+=C[a].speed,C[a].moving=!0):null!=c&&(0==C[a].swordFrame&&(C[a].swordFrame=1),C[a].frame<=3&&(C[a].frame=4),C[a].attack(c)),C[a].update()}},V=function(){for(var a=0;a<D.length;a++){for(var b=!0,c=null,d=0;d<D.length;d++)if(a!=d&&G(D[d].x,D[d].y,D[a].x,D[a].y)&&D[a].x>D[d].x){b=!1,D[a].moving=!1;break}for(var d=0;d<C.length;d++)if(G(C[d].x,C[d].y,D[a].x-s,D[a].y)){b=!1,D[a].moving=!1,c=C[d];break}b?(D[a].x-=D[a].speed,D[a].moving=!0):null!=c&&(0==D[a].swordFrame&&(D[a].swordFrame=1),D[a].frame<=3&&(D[a].frame=4),D[a].attack(c)),D[a].update()}},W=function(){x=new Date;var a=x-y;if(a>r){for(T();a>r;){var b=Math.floor(100*Math.random());1==b&&D.push(new K(n*s,s*(Math.floor(5*Math.random())+1))),U(),V(),R(),a-=r}y=x}requestAnimationFrame(X)},X=function(){l.fillStyle="#000",l.fillRect(0,0,k.width,k.height),l.drawImage(d,-q,s,n*s,p-s);var a=l.createLinearGradient(-q-s/8,0,s,0);a.addColorStop(0,"yellow"),a.addColorStop(.5,"transparent");var b=l.createLinearGradient(-q-s/8,0,s,0);if(b.addColorStop(0,"blue"),b.addColorStop(.5,"transparent"),l.fillStyle=a,l.fillRect(-q,s*v,s,s),t<=s&&u>=s){var c=Math.floor(u/s);c<m&&c!=v&&(l.fillStyle=b,l.fillRect(-q,c*s,s,s))}for(var e=0;e<C.length;e++)C[e].draw();for(var e=0;e<D.length;e++)D[e].draw();S(),setTimeout(W,r)}}();